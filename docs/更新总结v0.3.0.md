# 更新总结 v0.3.0 - 游戏流程优化

## 📅 更新日期: 2026-01-29

---

## ✨ 新功能概览

### 1. 推理阶段即时投票
**功能描述**: 在推理讨论时间内可以直接投票，不再需要等待独立的投票阶段

**核心特性**:
- 边看描述边投票，更符合自然游戏流程
- 显示实时投票进度（已投票人数 / 总人数）
- 如果全员都完成投票，立即跳过倒计时进入结果页面
- 可以随时修改投票选择
- 投票状态实时同步给所有玩家

**技术实现**:
- 修改 `submitVote` 方法支持 `DISCUSSING` 和 `VOTING` 两个阶段
- DiscussingPhase 组件集成投票UI
- 实时广播投票状态（votes字段）
- 全员投票后自动快进到结果阶段

**文件修改**:
- `src/server/game-manager.ts` - 允许 DISCUSSING 阶段投票
- `src/server/socket-server.ts` - 处理 DISCUSSING 阶段的投票快进
- `src/components/Game/DiscussingPhase.tsx` - 添加投票界面
- `src/types/game.ts` - SerializedRoom 添加 votes 字段

---

### 2. 游戏结束后准备系统
**功能描述**: 游戏结束后玩家留在房间，可以准备开始下一局

**核心特性**:
- 游戏结束后显示结果，但玩家留在房间
- 每个玩家可以点击"准备"按钮
- 显示所有玩家的准备状态
- 房主可以在全员准备后开始下一局
- 不需要重新创建房间或重新加入

**技术实现**:
- Player 接口添加 `isReady` 字段
- 新增 `toggleReady` Socket事件
- 新增 `restart_game` Socket事件（房主专用）
- 重置房间时保留玩家列表和已用词组历史
- 新建 GameEndedPhase 组件

**文件修改**:
- `src/types/game.ts` - Player 添加 isReady 字段
- `src/server/game-manager.ts` - 添加 toggleReady 和修改 resetRoom 方法
- `src/server/socket-server.ts` - 添加 toggle_ready 和 restart_game 处理器
- `src/types/socket.ts` - 添加新 Socket 事件类型
- `src/components/Game/GameEndedPhase.tsx` - 新建准备界面组件
- `src/app/room/[code]/page.tsx` - 集成准备系统

---

### 3. 可配置的时间设置
**功能描述**: 房主创建房间时可以自定义发言时间和推理时间

**核心特性**:
- **发言时间选项**: 15秒 / 30秒 / 45秒 / 60秒
- **推理时间选项**: 30秒 / 60秒 / 90秒 / 120秒
- 设置后应用于整个游戏所有回合
- 界面友好的按钮选择器

**技术实现**:
- Room 接口添加 `descriptionTime` 字段
- createRoom 方法接受时间参数
- 所有 start_turn 事件使用 room.descriptionTime
- CreateRoom 组件添加时间选择器

**文件修改**:
- `src/types/game.ts` - Room 添加 descriptionTime 字段
- `src/server/room-manager.ts` - createRoom 接受时间参数
- `src/server/socket-server.ts` - 使用 room.descriptionTime 代替硬编码
- `src/types/socket.ts` - create_room 事件添加时间参数
- `src/components/Room/CreateRoom.tsx` - 添加时间选择UI
- `src/app/page.tsx` - 传递时间参数到 Socket

---

## 🎮 优化后的游戏流程

### 完整游戏流程（单局）
```
1. 等待大厅
   ↓
2. 房主设置时间并开始游戏
   ↓
3. 角色揭示（你是卧底/平民，你的词语）
   ↓
4. 描述阶段（每人 15-60秒，轮流描述）
   ↓
5. 推理讨论阶段（30-120秒）⭐ 新增投票功能
   - 查看所有描述
   - 边讨论边投票
   - 实时显示投票进度
   - 全员投票后立即结算
   ↓
6. 投票结果（显示昵称和票数）
   ↓
7. 继续下一回合 或 游戏结束
   ↓
8. 游戏结束界面 ⭐ 新增准备系统
   - 显示胜负和词语
   - 玩家点击"准备"
   - 房主等全员准备后开始下一局
   ↓
9. 返回步骤2（新游戏）
```

### 多局游戏流程
```
第一局: 步骤 1-8
       ↓
第二局: 步骤 2-8（跳过步骤1，玩家已在房间）
       ↓
第三局: 步骤 2-8
       ↓
...（可以无限继续，直到玩家手动离开房间）
```

---

## 📊 技术细节

### 新增 Socket 事件

**客户端 → 服务器**:
```typescript
toggle_ready: {
  roomCode: string
} -> {
  success: boolean
  error?: string
  allReady?: boolean
}

restart_game: {
  roomCode: string
} -> {
  success: boolean
  error?: string
}
```

**create_room 更新**:
```typescript
// 之前
create_room: { nickname: string }

// 现在
create_room: {
  nickname: string
  descriptionTime?: number  // 默认 30
  discussionTime?: number   // 默认 60
}
```

### 数据结构变更

**Player 接口**:
```typescript
interface Player {
  // ... 原有字段
  isReady: boolean  // 新增：准备状态
}
```

**Room 接口**:
```typescript
interface Room {
  // ... 原有字段
  descriptionTime: number  // 新增：发言时间（秒）
  discussionTime: number   // 已有，现在可配置
}
```

**SerializedRoom 接口**:
```typescript
interface SerializedRoom {
  // ... 原有字段
  descriptionTime: number       // 新增
  votes?: Record<string, string>  // 新增：推理阶段显示投票
}
```

### 游戏阶段投票逻辑

| 阶段 | 可以投票 | 投票是否可见 | 全员投票后行为 |
|------|----------|--------------|----------------|
| WAITING | ❌ | - | - |
| DESCRIBING | ❌ | - | - |
| DISCUSSING | ✅ | ✅ 实时显示 | 立即跳转到结果 |
| VOTING | ✅ | ❌ 仅显示是否投票 | 立即处理结果 |
| RESULT | ❌ | ✅ 显示最终投票 | - |
| ENDED | ❌ | - | - |

---

## 🗂️ 文件变更统计

### 新建文件: 1个
- `src/components/Game/GameEndedPhase.tsx` - 游戏结束准备界面

### 修改文件: 9个
1. `src/types/game.ts` - 添加 isReady、descriptionTime 字段
2. `src/types/socket.ts` - 添加新事件类型和参数
3. `src/server/room-manager.ts` - createRoom 接受时间参数
4. `src/server/game-manager.ts` - 添加 toggleReady，修改 submitVote 和 resetRoom
5. `src/server/socket-server.ts` - 添加事件处理器，使用配置时间
6. `src/components/Room/CreateRoom.tsx` - 添加时间选择器UI
7. `src/components/Game/DiscussingPhase.tsx` - 集成投票功能
8. `src/app/page.tsx` - 传递时间参数
9. `src/app/room/[code]/page.tsx` - 集成准备系统和投票处理

### 代码行数: 新增约 300+ 行

---

## 🧪 测试清单

### 功能测试
- ✅ 创建房间时可以设置发言时间（15/30/45/60秒）
- ✅ 创建房间时可以设置推理时间（30/60/90/120秒）
- ✅ 推理阶段可以查看所有描述
- ✅ 推理阶段可以投票选择玩家
- ✅ 推理阶段显示实时投票进度
- ✅ 全员投票后立即跳转到结果（无需等待倒计时）
- ✅ 游戏结束后显示结果和准备按钮
- ✅ 玩家可以切换准备状态
- ✅ 显示所有玩家的准备状态
- ✅ 房主在全员准备后可以开始下一局
- ✅ 下一局游戏保持玩家列表不变
- ✅ 下一局游戏不重复使用相同词组

### 边界情况
- ✅ 推理阶段倒计时结束时，未投票玩家跳转到投票阶段
- ✅ 推理阶段全员投票后，正确跳过倒计时
- ✅ 非房主玩家无法点击"开始下一局"
- ✅ 未全员准备时，房主无法开始游戏
- ✅ 玩家可以随时修改投票选择
- ✅ 发言时间和推理时间正确应用到所有回合

### 构建测试
```bash
npm run build
✅ 编译成功
✅ 类型检查通过
✅ 所有路由生成成功
✅ 无错误或警告
```

---

## 💡 用户体验提升

### 更自然的游戏流程
**之前**: 描述 → 等待 60 秒 → 切换页面 → 投票
**现在**: 描述 → 边看边投票 → 立即结算

### 更高的游戏效率
- 全员投票后无需等待倒计时
- 推理和投票合并为一个阶段
- 减少了页面切换

### 更好的房间复用
**之前**: 每局游戏结束需要重新创建房间
**现在**: 一个房间可以玩无数局

### 更灵活的时间设置
- 快速游戏模式：15秒发言 + 30秒推理
- 标准游戏模式：30秒发言 + 60秒推理
- 休闲游戏模式：60秒发言 + 120秒推理

---

## 🎯 版本对比

| 功能 | v0.2.0 | v0.3.0 |
|------|--------|--------|
| 推理阶段投票 | ❌ | ✅ |
| 全员投票快进 | ❌ | ✅ |
| 游戏结束留在房间 | ❌ | ✅ |
| 准备系统 | ❌ | ✅ |
| 可配置发言时间 | ❌ | ✅ (15/30/45/60秒) |
| 可配置推理时间 | ✅ (固定60秒) | ✅ (30/60/90/120秒) |
| 房间复用 | ❌ | ✅ |

---

## 🚀 快速开始

```bash
# 开发模式
npm run dev

# 生产构建
npm run build
npm start

# 访问地址
http://localhost:3000        # 游戏主页
http://localhost:3000/admin  # 管理面板
```

---

## 📝 使用说明

### 创建房间（房主）
1. 输入昵称（或使用随机昵称）
2. 选择发言时间（默认30秒）
3. 选择推理时间（默认60秒）
4. 点击"创建房间"
5. 分享房间代码给其他玩家

### 游戏流程（所有玩家）
1. 等待玩家加入（3-8人）
2. 房主点击"开始游戏"
3. 查看自己的角色和词语
4. 轮流描述（注意时间限制）
5. **推理阶段**：
   - 查看所有玩家的描述
   - 点击玩家头像投票
   - 可以修改投票选择
   - 等待全员投票或倒计时结束
6. 查看投票结果和淘汰玩家
7. 继续下一回合或查看最终结果

### 开始下一局（游戏结束后）
1. 查看游戏结果（胜负、词语、卧底）
2. 点击"准备"按钮
3. 等待其他玩家准备
4. 房主点击"开始下一局"
5. 返回步骤2（新游戏开始）

---

## ⚠️ 注意事项

### 房主权限
- 只有房主可以开始游戏
- 只有房主可以在全员准备后开始下一局
- 房主离开房间会自动转移给其他玩家

### 投票规则
- 推理阶段可以随时投票和修改投票
- 无法投票给自己
- 已淘汰的玩家无法投票
- 全员投票后自动结算（无需等待倒计时）

### 时间设置
- 时间设置仅在创建房间时可配置
- 游戏开始后无法修改
- 所有回合使用相同的时间设置

---

## 🎉 总结

本次更新（v0.3.0）主要优化了游戏流程，使其更加自然和高效：

1. **推理阶段即时投票** - 减少等待，提高效率
2. **游戏结束后准备系统** - 房间复用，无需重复创建
3. **可配置时间设置** - 灵活适应不同游戏节奏

这些功能大幅提升了用户体验，使游戏流程更流畅，减少了不必要的等待和操作步骤。

**状态**: ✅ 生产就绪
**版本**: 0.3.0
**更新日期**: 2026-01-29

所有功能已实现、测试并优化完成！
